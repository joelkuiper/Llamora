{% macro keyword_chip(keyword, tag_hash, msg_id=None) -%}
  {% set canonical_value = display(keyword) %}
  <span class="meta-chip keyword">
    <a class="chip-label"
       href="{{ url_for('search.search') }}?q={{ canonical_value | urlencode }}"
       hx-get="{{ url_for('search.search') }}?q={{ canonical_value | urlencode }}"
       hx-target="#search-results"
       hx-indicator="#search-spinner"
       hx-swap="innerHTML">{{ canonical_value }}</a>
    {% if msg_id %}
    <button class="chip-remove"
            aria-label="Remove tag {{ canonical_value }}"
            hx-delete="{{ url_for('tags.remove_tag', msg_id=msg_id, tag_hash=tag_hash) }}"
            hx-target="closest .meta-chip"
            hx-swap="outerHTML swap:0.15s">&times;</button>
    {% endif %}
  </span>
{%- endmacro %}

{% macro render_meta_chips(msg_id, tags=[], hidden=False) -%}
  <meta-chips class="meta-chips"
              data-msg-id="{{ msg_id }}"
              data-autocomplete-url="{{ url_for('tags.autocomplete_tags') }}"
              data-autocomplete-limit="12"
              {% if hidden %}hidden{% endif %}>
    <button
      data-tooltip-title="Add traces"
      type="button"
      class="add-tag-btn"
      aria-label="Add traces">
      <img src="{{ url_for('static', filename='icons/tags.svg') }}"
           alt=""
           aria-hidden="true">
    </button>

    <div class="meta-tags" id="msg-tags-{{ msg_id }}">
      {% for tag in tags %}
      {{ keyword_chip(tag.name, tag.hash, msg_id) }}
      {% endfor %}
    </div>

    <div class="tag-popover glass-panel" role="dialog" aria-modal="true" hidden>
      <div class="tp-content">
        <button type="button" class="overlay-close" aria-label="Close">×</button>
        <form hx-post="{{ url_for('tags.add_tag', msg_id=msg_id) }}"
              hx-target="#msg-tags-{{ msg_id }}"
              hx-swap="beforeend">
          <input type="text"
                 name="tag"
                 placeholder="Something memorable…"
                 maxlength="{{ config.MAX_TAG_LENGTH }}"
                 autocomplete="off">
          <button type="submit" disabled>Add</button>
        </form>
        <div id="tag-suggestions-{{ msg_id }}-loading"
             class="search-result-load htmx-indicator"
             aria-hidden="true">
          <span class="search-load-indicator" aria-hidden="true"></span>
        </div>
        <div class="tag-suggestions"
             hx-get="{{ url_for('tags.get_entry_tag_suggestions', msg_id=msg_id) }}"
             hx-trigger="tag-popover:show"
             hx-indicator="#tag-suggestions-{{ msg_id }}-loading"
             hx-swap="innerHTML">
        </div>
      </div>
    </div>
  </meta-chips>
{%- endmacro %}
