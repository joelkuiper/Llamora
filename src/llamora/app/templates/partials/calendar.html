<section id="calendar" data-year="{{ year }}" data-month="{{ '%02d'|format(month) }}">
  <div class="calendar-nav">
    <button class="btn btn-pill cal-nav-btn prev"
            hx-get="{{ url_for('days.calendar_month', year=prev_year, month=prev_month) }}"
            hx-target="#calendar"
            hx-swap="outerHTML"
            aria-label="Previous month">&#9664;</button>
    <h2>{{ month_name }} {{ year }}</h2>
    <button class="btn btn-pill cal-nav-btn next"
            hx-get="{{ url_for('days.calendar_month', year=next_year, month=next_month) }}"
            hx-target="#calendar"
            hx-swap="outerHTML"
            aria-label="Next month">&#9654;</button>
  </div>
  <div class="calendar-today">
    <button class="today-btn"
       type="button"
       hx-get="{{ url_for('chat.chat_htmx_today') }}"
       hx-target="#content-wrapper"
       hx-swap="outerHTML"
       hx-push-url="true"
       data-date="{{ today }}">Today</button>
  </div>
  <table class="calendar-table"
         role="grid"
         aria-label="Calendar for {{ month_name }} {{ year }}"
         data-columns="7"
         data-calendar-grid>
    <thead>
      <tr>
        {% for d in ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"] %}
        <th scope="col" role="columnheader">{{ d }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for week in weeks %}
      <tr>
        {% for day in week %}
          {% if day == 0 %}
          <td class="empty" role="gridcell" tabindex="-1" aria-hidden="true" data-calendar-empty></td>
          {% else %}
          {% set date_str = "%04d-%02d-%02d"|format(year, month, day) %}
          {% set classes = [] %}
          {% if date_str == active_day %}{% set classes = classes + ['active'] %}{% endif %}
          {% if date_str == today %}{% set classes = classes + ['is-today'] %}{% endif %}
          {% if day in active_days %}{% set classes = classes + ['has-entry'] %}{% endif %}
          {% set is_today = (date_str == today) %}
          <td data-date="{{ date_str }}"
              data-calendar-cell
              role="gridcell"
              tabindex="{{ 0 if date_str == active_day else -1 }}"
              aria-selected="{{ 'true' if date_str == active_day else 'false' }}"
              {% if date_str == active_day %}data-calendar-active="true"{% endif %}
              {% if classes %} class="{{ classes|join(' ') }}"{% endif %}>
            {% if is_today or day in active_days %}
            <a{% if not is_today %} class="not-today"{% endif %}
               href="{{ url_for('days.day', date=date_str) }}"
               hx-get="{{ url_for('chat.chat_htmx', date=date_str) }}"
               hx-target="#content-wrapper"
               hx-swap="outerHTML"
               hx-push-url="true"
               tabindex="-1"
               {% if date_str == active_day %}aria-current="date"{% endif %}>{{ day }}</a>
            {% else %}
            <span class="no-messages">{{ day }}</span>
            {% endif %}
          </td>
          {% endif %}
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>
