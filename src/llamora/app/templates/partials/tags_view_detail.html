{% set detail = tags_view.detail if tags_view is defined and tags_view else None %}
{% set sort_kind = tags_sort_kind if tags_sort_kind is defined else (tags_view.sort_kind if tags_view is defined and tags_view else 'count') %}
{% set sort_dir = tags_sort_dir if tags_sort_dir is defined else (tags_view.sort_dir if tags_view is defined and tags_view else 'desc') %}
{% set selected_tag_name = detail.name if detail else (selected_tag if selected_tag is defined else '') %}
{% set tags_limit = tags_limit|default(50) %}
{% set entries_limit = entries_limit|default(12) %}
<section id="tags-view-detail"
         class="tags-view__detail span-9"
         data-selected-tag="{{ selected_tag_name }}"
         data-sort-kind="{{ sort_kind }}"
         data-sort-dir="{{ sort_dir }}">
  <div class="tags-view__detail-inner">
    {% if detail %}
      <header class="tags-view__detail-header">
        {% set delete_trace_url = url_for('tags.delete_trace', tag_hash=detail.hash) ~ '?day=' ~ day ~ '&sort_kind=' ~ sort_kind ~ '&sort_dir=' ~ sort_dir ~ '&tags_limit=' ~ tags_limit ~ '&entries_limit=' ~ entries_limit ~ '&tag=' ~ (detail.name|urlencode) ~ '&include_list=1' %}
        <div class="tags-view__title-row">
          <h2 class="tags-view__title">{{ detail.name }}</h2>
          <button class="entry-action entry-delete tags-view__trace-delete"
                  type="button"
                  hx-delete="{{ delete_trace_url }}"
                  hx-target="#tags-view-detail"
                  hx-swap="outerHTML"
                  hx-confirm="Delete this trace?"
                  data-confirm-title="Delete trace?"
                  data-confirm-message="This trace will be removed from all entries."
                  data-confirm-confirm="Delete"
                  data-confirm-cancel="Keep"
                  data-confirm-variant="danger"
                  aria-label="Delete trace"
                  data-tooltip-title="Delete trace">
            <span class="icon-mask icon-trash entry-action__icon" aria-hidden="true"></span>
          </button>
        </div>
        <p class="tags-view__meta">
          {{ detail.count }} {{ "entries" if detail.count != 1 else "entry" }} · first used {{ detail.first_used_label or "unknown" }}
        </p>
        {% if detail.related_tags %}
          <p class="tags-view__related">
            <span>Frequently appears with:</span>
            {% for related in detail.related_tags %}
              {% if not loop.first %}<span class="tags-view__dot">·</span>{% endif %}
              {% set related_target = 'tag-index-' ~ related.name %}
              {% set related_url = url_for('days.day', date=day) ~ '?view=tags&sort_kind=' ~ sort_kind ~ '&sort_dir=' ~ sort_dir ~ '&tags_limit=' ~ tags_limit ~ '&entries_limit=' ~ entries_limit ~ '&tag=' ~ (related.name|urlencode) ~ '&target=' ~ (related_target|urlencode) %}
              <a href="{{ related_url }}"
                 class="tags-view__related-link"
                 hx-get="{{ url_for('tags.tags_view_fragment', date=day) }}?sort_kind={{ sort_kind }}&sort_dir={{ sort_dir }}&tags_limit={{ tags_limit }}&entries_limit={{ entries_limit }}&tag={{ related.name|urlencode }}&target={{ related_target|urlencode }}"
                 hx-target="#tags-view-detail"
                 hx-swap="outerHTML"
                 hx-push-url="{{ related_url }}">
                {{ related.name }}
              </a>
            {% endfor %}
          </p>
        {% endif %}
      </header>

      <section class="tags-view__summary"
               hx-get="{{ url_for('tags.tag_detail_summary', tag_hash=detail.hash) }}?num_words=72"
               hx-trigger="load"
               hx-target="this"
               hx-swap="innerHTML"
               data-cache-key="tag-summary-{{ detail.hash }}-{{ detail.count }}-{{ detail.first_used }}-72"
               data-cache-ttl="21600">
        <div class="tag-detail-skeleton" aria-hidden="true">
          <span class="tag-detail-skeleton__line"></span>
          <span class="tag-detail-skeleton__line"></span>
        </div>
      </section>

      {% if detail.entries %}
        <ol class="tags-view__entries" data-tags-view-entries>
          {% set entries = detail.entries %}
          {% set has_more = detail.entries_has_more %}
          {% set next_cursor = detail.entries_next_cursor %}
          {% set page_size = entries_limit %}
          {% set tag_hash = detail.hash %}
          {% set selected_tag = selected_tag_name %}
          {% include 'partials/tags_view_entries_chunk.html' %}
        </ol>
      {% else %}
        <div class="tags-view__placeholder is-empty">
          <p>No entries linked to this trace yet.</p>
        </div>
      {% endif %}
    {% else %}
      <div class="tags-view__placeholder">
        <p>Select a trace to explore related entries.</p>
      </div>
    {% endif %}
  </div>
</section>
