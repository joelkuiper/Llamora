{% from 'partials/assistant_stream.html' import assistant_stream %}
{% from 'partials/message.html' import render_message %}
<div id="chat"
     data-date="{{ day }}"
     data-long-date="{{ day|long_date }}"
     {% if pending_msg_id -%}
     data-current-stream="{{ pending_msg_id }}"
     {% endif -%}
     role="log"
     aria-live="polite"
     aria-relevant="additions"
     aria-labelledby="chat-log-label-{{ day }}">
  <h2 class="visually-hidden" id="chat-log-label-{{ day }}">Conversation for {{ day|long_date }}</h2>
  {% if not history|length and not is_today %}
  <div class="no-content">Nothing was written this day.</div>
  {% endif %}
  {% for msg in history %}
  {% set msg_meta = msg.get('meta', {}) %}
  {% set rendered = msg.get('message_html') %}
  {{ render_message(
      msg['id'],
      msg['role'],
      body_html=rendered,
      body_text=msg.message,
      meta=msg_meta,
      tags=msg.get('tags', [])
    ) }}
  {% endfor %}
  {% if opening_stream %}
  {{ assistant_stream('opening', day, sse_url=url_for('chat.sse_opening', date=day)) }}
  {% endif %}
  {% if pending_msg_id %}
  {{ assistant_stream(pending_msg_id, day, stop_url=url_for('chat.stop_generation', user_msg_id=pending_msg_id)) }}
  {% endif %}
</div>
