{% from 'partials/meta_chips.html' import render_meta_chips %}
{% from 'partials/ask_llm_button.html' import ask_llm_button %}
<div id="chat"
     data-date="{{ day }}"
     data-long-date="{{ day|long_date }}"
     role="log"
     aria-live="polite"
     aria-relevant="additions"
     aria-labelledby="chat-log-label-{{ day }}">
  <h2 class="visually-hidden" id="chat-log-label-{{ day }}">Conversation for {{ day|long_date }}</h2>
  {% if not history|length and not is_today %}
  <div class="no-content">Nothing was written this day.</div>
  {% endif %}
  {% for msg in history %}
  {% set msg_meta = msg.get('meta', {}) %}
  {% set is_error = msg_meta.get('error') %}
  {% set repeat_guard = msg_meta.get('repeat_guard') %}
  {% set speaker = 'Your' if msg['role'] == 'user' else 'Assistant' %}
  <div id="msg-{{ msg['id'] }}"
       class="message {{ 'assistant' if msg['role'] != 'user' else 'user'}}{% if is_error %} message--error{% endif %}"
       data-message-id="{{ msg['id'] }}"
       {% if msg['role'] == 'assistant' and msg.get('reply_to') %}
       data-reply-to="{{ msg['reply_to'] }}"
       {% endif %}
       {% if repeat_guard %}data-repeat-guard="true"{% endif %}
       role="article"
       aria-labelledby="msg-{{ msg['id'] }}-speaker msg-{{ msg['id'] }}-body">
    <span class="visually-hidden" id="msg-{{ msg['id'] }}-speaker">{{ speaker }} message</span>
    {% set rendered = msg.get('message_html') %}
    <div class="message-main">
      <div class="markdown-body"
           id="msg-{{ msg['id'] }}-body"{% if rendered is not none %} data-rendered="true"{% endif %}>
        {% if rendered is not none %}
        {{ rendered | safe }}
        {% else %}
        {{ msg.message }}
        {% endif %}
      </div>
    </div>
    {% if msg['role'] == 'user' and not msg_meta.get('error') %}
    <div class="message-footer">
      {{ render_meta_chips(msg['id'], msg.get('tags', [])) }}
      <div class="message-actions" aria-label="Message actions">
        <button class="message-action message-delete"
                type="button"
                hx-delete="{{ url_for('chat.delete_message', msg_id=msg['id']) }}"
                hx-target="#msg-{{ msg['id'] }}"
                hx-swap="outerHTML swap:180ms"
                aria-label="Delete message"
                title="Delete message"
                data-ready="true">
          <svg class="message-action__icon" aria-hidden="true" viewBox="0 0 24 24">
            <path fill="currentColor" d="M9 3h6l1 2h4v2H4V5h4l1-2zm1 6h2v9h-2V9zm4 0h2v9h-2V9zM7 9h2v9H7V9zm-1 11h12a2 2 0 0 0 2-2V7H4v11a2 2 0 0 0 2 2z"/>
          </svg>
        </button>
        {{ ask_llm_button(msg['id'], day, reply_kinds) }}
      </div>
    </div>
    {% endif %}
    {% if msg['role'] == 'assistant' %}
      {% set reply_kind = msg_meta.get('reply_kind') %}
      {% if reply_kind and reply_kind_labels and reply_kind_labels.get(reply_kind) %}
      <span class="message-kind">{{ reply_kind_labels.get(reply_kind) }}</span>
      {% endif %}
    {% endif %}
    {% if repeat_guard %}
    <span class="repeat-guard-indicator repeat-guard-indicator--visible repeat-guard-indicator--calm">
      <span class="repeat-guard-indicator__label">response trimmed</span>
      <span class="visually-hidden">Response paused after repeating itself.</span>
    </span>
    {% endif %}
    {% if msg['role'] != 'user' %}
    <button class="message-action message-delete"
            type="button"
            hx-delete="{{ url_for('chat.delete_message', msg_id=msg['id']) }}"
            hx-target="#msg-{{ msg['id'] }}"
            hx-swap="outerHTML swap:180ms"
            aria-label="Delete message"
            title="Delete message"
            data-ready="true">
      <svg class="message-action__icon" aria-hidden="true" viewBox="0 0 24 24">
        <path fill="currentColor" d="M9 3h6l1 2h4v2H4V5h4l1-2zm1 6h2v9h-2V9zm4 0h2v9h-2V9zM7 9h2v9H7V9zm-1 11h12a2 2 0 0 0 2-2V7H4v11a2 2 0 0 0 2 2z"/>
      </svg>
    </button>
    {% endif %}
  </div>
  {% endfor %}
</div>
