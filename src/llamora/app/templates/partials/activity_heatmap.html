{% if activity_heatmap %}
  {% set selected_day = selected_day|default(day|default("")) %}
  <div class="activity-heatmap"
       hx-boost="true"
       hx-target="#main-content"
       hx-swap="outerHTML"
       hx-push-url="true">
    {% for month in activity_heatmap.months %}
      {% set prev_month = activity_heatmap.months[loop.index0 - 1] if loop.index0 > 0 else None %}
      {% set year_break = prev_month and prev_month.year != month.year %}
      <section class="activity-heatmap__month{% if year_break %} is-year-break{% endif %}"
               role="group"
               aria-labelledby="heatmap-month-{{ loop.index }}"
               data-year="{{ month.year }}">
        <div class="activity-heatmap__month-label" id="heatmap-month-{{ loop.index }}">
          {{ month.label }}
          {% if year_break %}
            <span class="activity-heatmap__year">{{ month.year }}</span>
          {% endif %}
        </div>
        <div class="activity-heatmap__grid" role="grid" aria-label="{{ month.aria_label }}">
          {% for week in month.weeks %}
            <div class="activity-heatmap__week" role="row">
              {% for cell in week.days %}
                {% if cell.in_month %}
                  {% set has_entries = cell.count > 0 %}
                  {% set entry_label = "entry" if cell.count == 1 else "entries" %}
                  {% if has_entries %}
                    {% set tooltip = (cell.date|long_date) ~ ' · ' ~ cell.count ~ ' ' ~ entry_label %}
                  {% else %}
                    {% set tooltip = (cell.date|long_date) ~ ' · No entries' %}
                  {% endif %}
                  <a class="activity-heatmap__cell level-{{ cell.level }}{% if not has_entries %} is-empty-day{% endif %}{% if today is defined and cell.date == today %} is-today{% endif %}{% if selected_day and cell.date == selected_day %} is-selected{% endif %}"
                     role="gridcell"
                     href="{{ url_for('days.day', date=cell.date) }}?view=diary"
                     aria-label="{{ tooltip }}"
                     data-heatmap-date="{{ cell.date }}"
                     data-heatmap-count="{{ cell.count }}"
                     {% if not has_entries %}aria-disabled="true" tabindex="-1"{% endif %}></a>
                {% else %}
                  <span class="activity-heatmap__cell is-empty" aria-hidden="true"></span>
                {% endif %}
              {% endfor %}
            </div>
          {% endfor %}
        </div>
      </section>
    {% endfor %}
  </div>
{% endif %}
