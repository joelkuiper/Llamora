{% macro entry_tag_item(
  label,
  tag_hash,
  entry_id=None,
  context_query='',
  tag_click_mode='detail',
  tag_navigate_page_template='',
  tag_navigate_fragment_template=''
) -%}
  {% set canonical_value = display(label) %}
  {% set encoded_value = canonical_value|urlencode %}
  {% if tag_click_mode == 'navigate' and tag_navigate_page_template %}
    {% set navigate_page_url = tag_navigate_page_template|replace('__TAG__', encoded_value) %}
  {% else %}
    {% set navigate_page_url = '' %}
  {% endif %}
  {% if tag_click_mode == 'navigate' and tag_navigate_fragment_template %}
    {% set navigate_fragment_url = tag_navigate_fragment_template|replace('__TAG__', encoded_value) %}
  {% else %}
    {% set navigate_fragment_url = '' %}
  {% endif %}
  <span class="entry-tag" data-tag-hash="{{ tag_hash }}" data-tag-name="{{ canonical_value }}">
    {% if tag_click_mode == 'navigate' and navigate_fragment_url %}
      <a class="tag-label"
         href="{{ navigate_page_url }}"
         hx-get="{{ navigate_fragment_url }}"
         hx-target="#tags-view-detail"
         hx-swap="outerHTML"
         hx-push-url="{{ navigate_page_url }}"
         data-tag-name="{{ canonical_value }}">{{ canonical_value }}</a>
    {% else %}
      <button class="tag-label"
              type="button"
              aria-haspopup="dialog"
              data-tag-hash="{{ tag_hash }}"
              data-tag-name="{{ canonical_value }}">{{ canonical_value }}</button>
    {% endif %}
    {% if entry_id %}
    <button class="tag-remove"
            aria-label="Remove trace {{ canonical_value }}"
            hx-delete="{{ url_for('tags.remove_tag', entry_id=entry_id, tag_hash=tag_hash) }}{{ context_query }}"
            hx-target="closest .entry-tag"
            hx-swap="outerHTML swap:0.15s">&times;</button>
    {% endif %}
  </span>
{%- endmacro %}

{% macro render_entry_tags(
  entry_id,
  tags=[],
  hidden=False,
  context_query='',
  tag_click_mode='detail',
  tag_navigate_page_template='',
  tag_navigate_fragment_template=''
) -%}
  <entry-tags class="entry-tags"
              data-entry-id="{{ entry_id }}"
              data-add-tag-url="{{ url_for('tags.add_tag', entry_id=entry_id) }}{{ context_query }}"
              data-suggestions-url="{{ url_for('tags.get_tag_suggestions', entry_id=entry_id) }}{{ context_query }}"
              data-tag-detail-url="{{ url_for('tags.tag_detail', tag_hash='__TAG_HASH__') }}"
              data-tag-click-mode="{{ tag_click_mode }}"
              {% if tag_navigate_page_template %}data-tag-navigate-page-template="{{ tag_navigate_page_template }}"{% endif %}
              {% if tag_navigate_fragment_template %}data-tag-navigate-fragment-template="{{ tag_navigate_fragment_template }}"{% endif %}
              data-autocomplete-limit="12"
              hx-trigger="restored"
              {% if hidden %}hidden{% endif %}>
    <button
      data-tooltip-title="Add traces"
      type="button"
      class="add-tag-btn"
      aria-label="Add traces">
      <span class="icon-mask icon-tag" aria-hidden="true"></span>
    </button>

    <div class="entry-tags-list" id="entry-tags-{{ entry_id }}">
      {% for tag in tags %}
      {{ entry_tag_item(
          tag.name,
          tag.hash,
          entry_id,
          context_query=context_query,
          tag_click_mode=tag_click_mode,
          tag_navigate_page_template=tag_navigate_page_template,
          tag_navigate_fragment_template=tag_navigate_fragment_template
        ) }}
      {% endfor %}
    </div>
  </entry-tags>
{%- endmacro %}
