{% set detail = tags_view.detail if tags_view is defined and tags_view else None %}
{% set sort_kind = tags_sort_kind if tags_sort_kind is defined else (tags_view.sort_kind if tags_view is defined and tags_view else 'count') %}
{% set sort_dir = tags_sort_dir if tags_sort_dir is defined else (tags_view.sort_dir if tags_view is defined and tags_view else 'desc') %}
{% set selected_tag_name = detail.name if detail else (selected_tag if selected_tag is defined else '') %}
{% set entries_limit = entries_limit|default(12) %}
{% set tags_day_query = tags_day_query|default('?day=' ~ (day|urlencode)) %}
{% set tags_selected_query = tags_selected_query|default(tags_day_query ~ (('&tag=' ~ (selected_tag_name|urlencode)) if selected_tag_name else '')) %}
{% if oob_view_state %}
  {% set view_state = view_state if view_state is defined else {
    'view': 'tags',
    'day': day,
    'selected_tag': selected_tag_name
  } %}
  {% include "components/shared/view_state.html" %}
{% endif %}
<section id="tags-view-detail"
         class="tags-view__detail span-9"
         {% if oob_detail %}hx-swap-oob="outerHTML"{% endif %}
         data-selected-tag="{{ selected_tag_name }}"
         data-selected-tag-hash="{{ detail.hash if detail else '' }}"
         data-sort-kind="{{ sort_kind }}"
         data-sort-dir="{{ sort_dir }}"
         {% if detail %}data-selected-tag-count="{{ detail.count }}"{% endif %}>
  <input type="hidden"
         id="tags-view-selected-tag"
         name="tag"
         value="{{ selected_tag_name }}">
  <input type="hidden" name="user_time" id="user-time" />
  <div class="tags-view__detail-inner">
    {% if detail %}
      <header class="tags-view__detail-header">
        {% set delete_trace_url = url_for('tags.delete_trace', tag_hash=detail.hash) ~ tags_selected_query %}
        {% set detail_shortcode = emoji_shortcode(detail.name) %}
        <div class="tags-view__title-wrap">
          <div class="tags-view__title-row">
            <h2 class="tags-view__title">
              <span class="tags-view__title-main">{{ detail.name }}</span>
              {% if detail_shortcode %}
                <span class="tags-view__title-hint">{{ detail_shortcode }}</span>
              {% endif %}
            </h2>
            <button class="entry-action entry-delete tags-view__trace-delete"
                    type="button"
                    hx-delete="{{ delete_trace_url }}"
                    hx-target="#tags-view-detail"
                    hx-swap="outerHTML"
                    hx-confirm="Delete this trace?"
                    data-confirm-title="Delete trace?"
                    data-confirm-message="This trace will be removed from all entries."
                    data-confirm-confirm="Delete"
                    data-confirm-cancel="Keep"
                    data-confirm-variant="danger"
                    aria-label="Delete trace"
                    data-tooltip-title="Delete trace">
              <span class="icon-mask icon-trash entry-action__icon" aria-hidden="true"></span>
            </button>
          </div>
          <p class="tags-view__meta ui-meta-text">
            {{ detail.count }} {{ "entries" if detail.count != 1 else "entry" }} Â·
            {% if detail.first_used_label %}since {{ detail.first_used_label }}{% else %}first used unknown{% endif %}
          </p>
          <div class="tags-view__related{% if not detail.related_tags %} tags-view__related--solo{% endif %}">
            {% if detail.related_tags %}
              <div class="tags-view__related-row">
                <span class="tags-view__related-prefix ui-meta-text">frequently appears with</span>
                {% for related in detail.related_tags %}
                  {% set related_url = url_for('tags.tags_view_tag', tag=related.name) ~ tags_day_query %}
                  <a href="{{ related_url }}"
                     class="tags-view__related-link entry-tag"
                     data-tag-name="{{ related.name }}"
                     {% if related.hash %}data-tag-hash="{{ related.hash }}"{% endif %}
                     hx-get="{{ url_for('tags.tags_view_detail_fragment', date=day) }}?tag={{ related.name|urlencode }}{% if related.hash %}&tag_hash={{ related.hash }}{% endif %}"
                     hx-target="#tags-view-detail"
                     hx-swap="outerHTML"
                     hx-sync="#tags-view-detail:replace"
                     hx-push-url="{{ related_url }}">
                    <span class="tag-label">{{ related.name }}</span>
                  </a>
                {% endfor %}
              </div>
            {% else %}
              <div class="tags-view__related-row tags-view__related-row--empty" aria-hidden="true">
                <span class="tags-view__related-prefix ui-meta-text">frequently appears with</span>
              </div>
            {% endif %}
            {% include 'components/tags/heatmap.html' %}
          </div>
          <section class="tags-view__summary tags-view__summary--header"
                   hx-get="{{ url_for('tags.tag_detail_summary', tag_hash=detail.hash) }}?num_words=72"
                   hx-trigger="tag-summary:load"
                   hx-target="this"
                   hx-swap="innerHTML"
                   data-summary-digest="{{ detail.summary_digest }}"
                   data-summary-words="72"
                   data-summary-lines="4"
                   data-tag-hash="{{ detail.hash }}"
                   data-cache-namespace="summary"
                   data-cache-key="tag:{{ detail.hash }}:w72"
                   data-cache-digest="{{ detail.summary_digest }}"
                   data-cache-kind="summary"
                   data-cache-trigger="tag-summary:load">
            {% with lines=4 %}
              {% include 'components/shared/summary_shimmer.html' %}
            {% endwith %}
          </section>
        </div>
      </header>

      {% if detail.entries %}
        <ol id="entries" class="tags-view__entries" data-tags-view-entries>
          {% set entries = detail.entries %}
          {% set has_more = detail.entries_has_more %}
          {% set next_cursor = detail.entries_next_cursor %}
          {% set page_size = entries_limit %}
          {% set tag_hash = detail.hash %}
          {% set selected_tag = selected_tag_name %}
          {% include 'components/tags/entries_chunk.html' %}
        </ol>
      {% else %}
        <div class="tags-view__placeholder is-empty">
          <div class="ui-empty-state ui-empty-state--left">
            <p class="ui-empty-state__title">No entries yet</p>
            <p class="ui-empty-state__description">This trace is not linked to any entries.</p>
          </div>
        </div>
      {% endif %}
    {% else %}
      <div class="tags-view__placeholder">
        <div class="ui-empty-state">
          <p class="ui-empty-state__title">Select a trace</p>
          <p class="ui-empty-state__description">Explore related entries in context.</p>
        </div>
      </div>
    {% endif %}
  </div>
</section>
