#!/bin/sh
set -eu

script_dir=$(CDPATH= cd -- "$(dirname -- "$0")" && pwd)
cached_bin="$script_dir/esbuild-0.27.0"

is_valid_bin() {
  "$cached_bin" --version >/dev/null 2>&1
}

if [ ! -x "$cached_bin" ]; then
  :
elif ! is_valid_bin; then
  rm -f "$cached_bin"
fi

if [ ! -x "$cached_bin" ]; then
  dir=$(mktemp -d)
  cleanup() {
    rm -rf "$dir"
  }
  trap cleanup EXIT

  platform=$(uname -ms)
  tgz="$dir/esbuild-0.27.0.tgz"

  # Download the binary executable for the current platform
  case $platform in
    'Darwin arm64') curl -fo "$tgz" "https://registry.npmjs.org/@esbuild/darwin-arm64/-/darwin-arm64-0.27.0.tgz";;
    'Darwin x86_64') curl -fo "$tgz" "https://registry.npmjs.org/@esbuild/darwin-x64/-/darwin-x64-0.27.0.tgz";;
    'Linux arm64' | 'Linux aarch64') curl -fo "$tgz" "https://registry.npmjs.org/@esbuild/linux-arm64/-/linux-arm64-0.27.0.tgz";;
    'Linux x86_64') curl -fo "$tgz" "https://registry.npmjs.org/@esbuild/linux-x64/-/linux-x64-0.27.0.tgz";;
    'NetBSD amd64') curl -fo "$tgz" "https://registry.npmjs.org/@esbuild/netbsd-x64/-/netbsd-x64-0.27.0.tgz";;
    'OpenBSD arm64') curl -fo "$tgz" "https://registry.npmjs.org/@esbuild/openbsd-arm64/-/openbsd-arm64-0.27.0.tgz";;
    'OpenBSD amd64') curl -fo "$tgz" "https://registry.npmjs.org/@esbuild/openbsd-x64/-/openbsd-x64-0.27.0.tgz";;
    *) echo "error: Unsupported platform: $platform"; exit 1;;
  esac

  # Extract the binary executable next to this script
  tar -xzf "$tgz" -C "$dir" package/bin/esbuild
  mv "$dir/package/bin/esbuild" "$cached_bin"
  rm "$tgz"
  cleanup
  trap - EXIT
  chmod +x "$cached_bin"
fi

exec "$cached_bin" "$@"
