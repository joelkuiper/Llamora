{% from 'partials/bot_stream.html' import bot_stream %}
{% from 'partials/meta_chips.html' import render_meta_chips %}

<main
  id="content-wrapper"
  {% if oob %} hx-swap-oob="true" {% endif %}>

    <div id="chat" data-session-id="{{ session.id }}">
      <div class="message bot"><div class="markdown-body">Welcome. Share what’s on your mind, and I’ll be here with you</div></div>
      {% for msg in history %}
      <div id="msg-{{ msg['id'] }}" class="message {{ 'bot' if msg['role'] != 'user' else 'user'}}">
        <div class="markdown-body">{{ msg.message }}</div>
        {% if msg.meta %}
        {{ render_meta_chips(msg.meta) }}
        {% endif %}
      </div>
      {% endfor %}

      {% if pending_msg_id %}
      {{ bot_stream(pending_msg_id, session.id) }}
      {% endif %}
    </div>

  <form id="message-form"
        hx-post="{{ url_for('chat.send_message', session_id=session.id) }}"
        hx-target="#chat"
        hx-on::after-request="this.reset()"
        hx-swap="beforeend">

    <div class="input-wrapper">
        <textarea class="input"
          onkeydown="if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); this.form.requestSubmit(); }"
          name="message"
          rows="3"
          placeholder="Write your thoughts here…"
          cols="40"
          maxlength="{{ config.MAX_MESSAGE_LENGTH }}"></textarea>
        <button id="send-btn" class="btn" type="submit" aria-label="Send"></button>
      </div>
  </form>
  <div id="scroll-bottom-container">
    <button id="scroll-bottom" class="scroll-btn" aria-label="Scroll to bottom">
      <svg width="100%" height="100%" viewBox="0 0 24 24"
           fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M8 12L12 16M12 16L16 12M12 16V8"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"/>
      </svg>
    </button>
  </div>
  <script type="module">
    import { initChatUI } from "{{ url_for('static', filename='js/chat.js') }}";
    import { updateActiveSession } from "{{ url_for('static', filename='js/session.js') }}";
    import { initSearchUI, scrollToHighlight } from "{{ url_for('static', filename='js/ui.js') }}";
    initChatUI();
    updateActiveSession();
    initSearchUI();
    scrollToHighlight();
    document.title = "{{ session.name }}";
  </script>
</main>
