{% macro keyword_chip(keyword, tag_hash, msg_id=None) -%}
  {% set display = keyword if keyword.startswith('#') else '#' ~ keyword %}
  <span class="meta-chip keyword">
    <a class="chip-label"
       href="{{ url_for('search.search') }}?q={{ display | urlencode }}"
       hx-get="{{ url_for('search.search') }}?q={{ display | urlencode }}"
       hx-target="#search-results"
       hx-indicator="#search-spinner"
       hx-swap="innerHTML"
       hx-on:click="var i=document.getElementById('search-input');i.value=this.textContent;i.focus()">{{ display }}</a>
    {% if msg_id %}
    <button class="chip-remove"
            hx-delete="{{ url_for('tags.remove_tag', msg_id=msg_id, tag_hash=tag_hash) }}"
            hx-target="closest .meta-chip"
            hx-swap="outerHTML swap:0.15s">&times;</button>
    {% endif %}
  </span>
{%- endmacro %}

{% macro render_meta_chips(msg_id, tags=[], hidden=False) -%}
  <div class="meta-chips" data-msg-id="{{ msg_id }}" {% if hidden %}hidden{% endif %}>
    <button type="button" class="add-tag-btn">
      <svg width="100%" height="100%" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 13V7M9 10H15M19 21V7.8C19 6.11984 19 5.27976 18.673 4.63803C18.3854 4.07354 17.9265 3.6146 17.362 3.32698C16.7202 3 15.8802 3 14.2 3H9.8C8.11984 3 7.27976 3 6.63803 3.32698C6.07354 3.6146 5.6146 4.07354 5.32698 4.63803C5 5.27976 5 6.11984 5 7.8V21L12 17L19 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>

    <div class="meta-tags", id="msg-tags-{{ msg_id }}">
      {% for tag in tags %}
      {{ keyword_chip(tag.name, tag.hash, msg_id) }}
      {% endfor %}
    </div>

    <div class="tag-popover" role="tooltip" hidden>
      <div class="tp-content">
        <button type="button" class="overlay-close" aria-label="Close">Ã—</button>
        <form hx-post="{{ url_for('tags.add_tag', msg_id=msg_id) }}"
              hx-target="#msg-tags-{{ msg_id }}"
              hx-swap="beforeend">
          <input type="text"
                 name="tag"
                 placeholder="Add a tag"
                 maxlength="{{ config.MAX_TAG_LENGTH }}">
          <button type="submit" disabled>Add</button>
        </form>
        <div class="tag-suggestions"
             hx-get="{{ url_for('tags.get_tag_suggestions', msg_id=msg_id) }}"
             hx-trigger="revealed"
             hx-swap="innerHTML">
        </div>
      </div>
    </div>
  </div>
{%- endmacro %}
