<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ config.APP_NAME }}</title>
    <link rel="icon" href="{{url_for('static', filename='img/favicon.ico')}}" type="image/x-icon">

    <script defer src="{{url_for('static', filename='js/vendor/htmx.min.js')}}"></script>
    <script defer src="{{url_for('static', filename='js/vendor/htmx-ext-sse.js')}}"></script>
    <script defer src="{{url_for('static', filename='js/vendor/htmx-ext-response-targets.js')}}"></script>

    <script defer src="{{url_for('static', filename='js/vendor/marked.umd.js')}}"></script>
    <script defer src="{{url_for('static', filename='js/vendor/purify.min.js')}}"></script>
    <script defer src="{{url_for('static', filename='js/vendor/popper.min.jsm.js')}}"></script>

    <script defer type="module" src="{{url_for('static', filename='js/tooltip.js')}}"></script>
    <script defer type="module" src="{{url_for('static', filename='js/components/calendar.js')}}"></script>


    <link rel="stylesheet" href="{{url_for('static', filename='css/main.css')}}">
    <link rel="stylesheet" href="{{url_for('static', filename='css/chat.css')}}">
    <link rel="stylesheet" href="{{url_for('static', filename='css/search.css')}}">
    <link rel="stylesheet" href="{{url_for('static', filename='css/profile.css')}}">
    <link rel="stylesheet" href="{{url_for('static', filename='css/meta-chips.css')}}">
    <link rel="stylesheet" href="{{url_for('static', filename='css/calendar.css')}}">


  </head>
  <body
    hx-ext="response-targets"
    hx-target-5*="#errors"
    hx-target-4*="#errors">

    <div id="errors" hx-swap="beforeend"></div>
    <header id="search-container">

      <div id="branding">
        <img class="logo" src="{{url_for('static', filename='img/logo.svg')}}" alt="Logo">
        <h1>{{ config.APP_NAME }}</h1>
      </div>

      <calendar-control id="calendar-control">
        <button id="prev-day" type="button" class="icon-btn" aria-label="Previous day" data-tooltip-title="Previous day">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
        </button>
        <button id="calendar-btn" type="button" class="icon-btn" aria-label="Calendar" data-tooltip-title="Change day">
          <svg width="100%" height="100%" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M21 10H3M16 2V6M8 2V6M7.8 22H16.2C17.8802 22 18.7202 22 19.362 21.673C19.9265 21.3854 20.3854 20.9265 20.673 20.362C21 19.7202 21 18.8802 21 17.2V8.8C21 7.11984 21 6.27976 20.673 5.63803C20.3854 5.07354 19.9265 4.6146 19.362 4.32698C18.7202 4 17.8802 4 16.2 4H7.8C6.11984 4 5.27976 4 4.63803 4.32698C4.07354 4.6146 3.6146 5.07354 3.32698 5.63803C3 6.27976 3 7.11984 3 8.8V17.2C3 18.8802 3 19.7202 3.32698 20.362C3.6146 20.9265 4.07354 21.3854 4.63803 21.673C5.27976 22 6.11984 22 7.8 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span id="calendar-label">{{ day|long_date }}</span>
        </button>
        <button id="next-day" disabled type="button" class="icon-btn" aria-label="Next day" data-tooltip-title="Next day">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
        </button>
        <div id="calendar-popover" class="calendar-popover" role="tooltip" hidden
             hx-get="{{ url_for('days.calendar_view') }}"
             hx-trigger="calendar-popover:show"
             hx-swap="innerHTML"></div>
      </calendar-control>

      <div class="header-right">
        <div class="search-wrap">
          <search-overlay>
            {% include 'partials/search_form.html' %}
            <section id="search-results">
              {% include 'partials/search_results.html' %}
            </section>
          </search-overlay>
        </div>
        <div class="user-actions">
          <a id="profile-btn"
             href="{{ url_for('auth.profile') }}"
             hx-get="{{ url_for('auth.profile') }}"
             hx-target="#content-wrapper"
             hx-swap="outerHTML"
             hx-push-url="true"
             class="icon-btn"
             aria-label="Profile" data-tooltip-title="Profile">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M4 20c0-4 4-6 8-6s8 2 8 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </a>
          <form method="post" action="{{ url_for('auth.logout') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="icon-btn" aria-label="Logout" data-tooltip-title="Logout">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M16 17l5-5-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M21 12H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 19H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </form>
        </div>
      </div>
    </header>

    <div class="app-container">
      <div id="content">
        {% set tpl = content_template if content_template is defined else 'partials/chat.html' %}
        {% include tpl %}
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        document.body.addEventListener('htmx:configRequest', (event) => {
            event.detail.headers['X-CSRFToken'] = '{{ csrf_token() }}';
        });

        document.body.addEventListener('htmx:configRequest', (event) => {
            const chat = document.getElementById('chat');
            const activeDate = chat?.dataset.date;
            if (activeDate) {
                event.detail.headers['X-Active-Day'] = activeDate;
            }
        });

        function showServerError() {
            const errors = document.getElementById('errors');
            if (!errors) return;
            const box = document.createElement('div');
            box.className = 'error-box';
            box.textContent = '⚠️ Unable to reach server.';
            const btn = document.createElement('button');
            btn.className = 'close-error';
            btn.setAttribute('aria-label', 'Close error');
            btn.textContent = '×';
            btn.onclick = () => box.remove();
            box.appendChild(btn);
            errors.appendChild(box);
        }

        document.body.addEventListener('htmx:sendError', showServerError);
        // document.body.addEventListener('htmx:responseError', showServerError);
      });
    </script>

    <script defer type="module">
      document.addEventListener('DOMContentLoaded', () => {
        import("{{ url_for('static', filename='js/scroll.js') }}").then(({ initScrollMemory }) => {
          initScrollMemory();
        });

        const profileBtn = document.getElementById('profile-btn');
        profileBtn?.addEventListener('click', () => {
          const { pathname, search, hash } = window.location;
          sessionStorage.setItem('profile-return', `${pathname}${search}${hash}`);
        });
      });
    </script>
  </body>
</html>
