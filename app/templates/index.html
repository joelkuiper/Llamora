<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Minimal Flask chat app</title>
    <script src="{{url_for('static', filename='js/vendor/htmx.min.js')}}"></script>
    <script src="{{url_for('static', filename='js/vendor/htmx-ext-sse.js')}}"></script>
    <script src="{{url_for('static', filename='js/vendor/htmx-ext-response-targets.js')}}"></script>

    <link rel="stylesheet" href="{{url_for('static', filename='css/main.css')}}">
  </head>
  <body
    hx-ext="response-targets"
    hx-target-5*="#errors"
    hx-target-4*="#errors">

    <div id="errors"></div>
    <div class="app-container">
      {% include "partials/sidebar.html" %}
      <main id="chatbox-wrapper"
            hx-on::after-swap="window.updateActiveSession()">
        {% include "partials/chat.html" %}
      </main>
    </div>

    <script>
      document.body.addEventListener('htmx:configRequest', (event) => {
          event.detail.headers['X-CSRFToken'] = '{{ csrf_token() }}';
      });

      /* Update the active session in the sidebar */
      window.updateActiveSession = function () {
          const marker = document.getElementById("session-marker");
          if (!marker) return;

          const newSessionId = marker.dataset.sessionId;

          document.querySelectorAll("#sidebar li").forEach((li) => {
              const link = li.querySelector("a");
              if (link?.dataset.sessionId === newSessionId) {
                  li.classList.add("active");
              } else {
                  li.classList.remove("active");
              }
          });
      };
    </script>
  </body>
</html>
