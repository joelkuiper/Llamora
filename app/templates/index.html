<!DOCTYPE html>
{% from 'partials/meta_chips.html' import meta_chip_templates %}
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>{{ config.APP_NAME }}</title>
    <link rel="icon" href="{{url_for('static', filename='img/favicon.ico')}}" type="image/x-icon">

    <script src="{{url_for('static', filename='js/vendor/htmx.min.js')}}"></script>
    <script src="{{url_for('static', filename='js/vendor/htmx-ext-sse.js')}}"></script>
    <script src="{{url_for('static', filename='js/vendor/htmx-ext-response-targets.js')}}"></script>

    <script src="{{url_for('static', filename='js/vendor/marked.umd.js')}}"></script>
    <script src="{{url_for('static', filename='js/vendor/purify.min.js')}}"></script>


    <link rel="stylesheet" href="{{url_for('static', filename='css/main.css')}}">
    <link rel="stylesheet" href="{{url_for('static', filename='css/chat.css')}}">
    <link rel="stylesheet" href="{{url_for('static', filename='css/search.css')}}">
    <link rel="stylesheet" href="{{url_for('static', filename='css/sidebar.css')}}">
    <link rel="stylesheet" href="{{url_for('static', filename='css/profile.css')}}">

  </head>
  <body
    hx-ext="response-targets"
    hx-target-5*="#errors"
    hx-target-4*="#errors">

    <div id="errors" hx-swap="beforeend"></div>
    {{ meta_chip_templates() }}
    <header id="search-container">

      <div id="branding">
        <img class="logo" src="{{url_for('static', filename='img/logo.svg')}}" alt="Logo">
        <h1>{{ config.APP_NAME }}</h1>
      </div>

      <button id="sidebar-toggle" class="icon-btn" aria-label="Toggle sidebar" aria-pressed="false" data-popup-title="Toggle sidebar">
        <svg class="icon-closed" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <!-- outer page -->
          <rect x="3" y="5" width="18" height="14" rx="3"
                stroke="currentColor" stroke-width="2"/>
          <!-- vertical divider (sidebar) -->
          <line x1="9.75" y1="5" x2="9.75" y2="19"
                stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <!-- triangle pointing LEFT -->
          <polygon points="13,12 16.5,10 16.5,14"
                   fill="currentColor" />
        </svg>

        <svg class="icon-open" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <!-- outer page -->
          <rect x="3" y="5" width="18" height="14" rx="3"
                stroke="currentColor" stroke-width="2"/>
          <!-- thin left sliver hint -->
          <rect x="4.5" y="6.5" width="1.6" height="11" rx="0.8"
                fill="currentColor" opacity=".22"/>
          <!-- triangle pointing RIGHT -->
          <polygon points="11,12 7.5,10 7.5,14"
                   fill="currentColor" />
        </svg>
      </button>



      <div class="header-right">
        <div class="search-wrap">
          {% include 'partials/search_form.html' %}
          <section id="search-results">
            {% include 'partials/search_results.html' %}
          </section>
        </div>
        <div class="user-actions">
          <a id="profile-btn"
             href="{{ url_for('auth.profile') }}"
             hx-get="{{ url_for('auth.profile') }}"
             hx-target="#content-wrapper"
             hx-swap="outerHTML"
             hx-push-url="true"
             class="icon-btn"
             aria-label="Profile" data-popup-title="Profile">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M4 20c0-4 4-6 8-6s8 2 8 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </a>
          <form method="post" action="{{ url_for('auth.logout') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="icon-btn" aria-label="Logout" data-popup-title="Logout">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M16 17l5-5-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M21 12H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 19H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </form>
        </div>
      </div>
    </header>

    <div class="app-container">
      {% include "partials/sidebar.html" %}
      <div id="content">
        {% set tpl = content_template if content_template is defined else 'partials/chat.html' %}
        {% include tpl %}
      </div>
    </div>

    <script>
      document.body.addEventListener('htmx:configRequest', (event) => {
          event.detail.headers['X-CSRFToken'] = '{{ csrf_token() }}';
      });

      document.body.addEventListener("htmx:configRequest", function (event) {
          const chat = document.getElementById("chat");
          const activeSessionId = chat?.dataset.sessionId;
          if (activeSessionId) {
              event.detail.headers["X-Active-Session"] = activeSessionId;
          }
      });


      function showServerError() {
          const errors = document.getElementById("errors");
          if (!errors) return;
          const box = document.createElement("div");
          box.className = "error-box";
          box.textContent = "⚠️ Unable to reach server.";
          const btn = document.createElement("button");
          btn.className = "close-error";
          btn.setAttribute("aria-label", "Close error");
          btn.textContent = "×";
          btn.onclick = () => box.remove();
          box.appendChild(btn);
          errors.appendChild(box);
      }

      document.body.addEventListener("htmx:sendError", showServerError);
      // document.body.addEventListener("htmx:responseError", showServerError);
    </script>

    <script type="module">
      import { initSidebarToggle } from "{{ url_for('static', filename='js/sidebar.js') }}";
      import { initScrollMemory } from "{{ url_for('static', filename='js/scroll.js') }}";
      initSidebarToggle();
      initScrollMemory();
    </script>
  </body>
</html>
