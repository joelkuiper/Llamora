<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>{{ config.APP_NAME }}</title>
    <link rel="icon" href="{{url_for('static', filename='img/favicon.ico')}}" type="image/x-icon">

    <script src="{{url_for('static', filename='js/vendor/htmx.min.js')}}"></script>
    <script src="{{url_for('static', filename='js/vendor/htmx-ext-sse.js')}}"></script>
    <script src="{{url_for('static', filename='js/vendor/htmx-ext-response-targets.js')}}"></script>

    <script src="{{url_for('static', filename='js/vendor/marked.umd.js')}}"></script>
    <script src="{{url_for('static', filename='js/vendor/purify.min.js')}}"></script>


    <link rel="stylesheet" href="{{url_for('static', filename='css/main.css')}}">
    <link rel="stylesheet" href="{{url_for('static', filename='css/chat.css')}}">
  </head>
  <body
    hx-ext="response-targets"
    hx-target-5*="#errors"
    hx-target-4*="#errors">

    <div id="errors" hx-swap="beforeend"></div>
    <header id="search-container">
      <button id="sidebar-toggle" class="icon-btn" aria-label="Toggle sidebar">
        <svg class="icon-close" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <svg class="icon-open" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <div id="branding">
        <img class="logo" src="{{url_for('static', filename='img/logo.svg')}}" alt="Logo">
        <h1>{{ config.APP_NAME }}</h1>
      </div>
      <div class="header-right">
        <div class="search-wrap">
          {% include 'partials/search_form.html' %}
          <section id="search-results">
            {% include 'partials/search_results.html' %}
          </section>
        </div>
        <div class="user-actions">
          <a href="{{ url_for('auth.profile') }}" class="icon-btn" aria-label="Profile">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M4 20c0-4 4-6 8-6s8 2 8 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </a>
          <a href="{{ url_for('auth.logout') }}" class="icon-btn" aria-label="Logout">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M16 17l5-5-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M21 12H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M12 19H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </a>
        </div>
      </div>
    </header>

    <div class="app-container">
      {% include "partials/sidebar.html" %}
      <div id="content">
        {% include "partials/chat.html" %}
      </div>
    </div>

    <script>
      document.body.addEventListener('htmx:configRequest', (event) => {
        event.detail.headers['X-CSRFToken'] = '{{ csrf_token() }}';
      });

      document.body.addEventListener("htmx:configRequest", function (event) {
        const chat = document.getElementById("chat");
        const activeSessionId = chat?.dataset.sessionId;
        if (activeSessionId) {
          event.detail.headers["X-Active-Session"] = activeSessionId;
        }
      });


      function showServerError() {
        const errors = document.getElementById("errors");
        if (!errors) return;
        const box = document.createElement("div");
        box.className = "error-box";
        box.textContent = "⚠️ Unable to reach server.";
        const btn = document.createElement("button");
        btn.className = "close-error";
        btn.setAttribute("aria-label", "Close error");
        btn.textContent = "×";
        btn.onclick = () => box.remove();
        box.appendChild(btn);
        errors.appendChild(box);
      }

      document.body.addEventListener("htmx:sendError", showServerError);
      // document.body.addEventListener("htmx:responseError", showServerError);
    </script>

    <script type="module">
      import { initSidebarToggle } from "{{ url_for('static', filename='js/sidebar.js') }}";
      initSidebarToggle();
    </script>
  </body>
</html>
