<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>{{ config.APP_NAME }}</title>
    <link rel="icon" href="{{url_for('static', filename='img/favicon.ico')}}" type="image/x-icon">

    <script src="{{url_for('static', filename='js/vendor/htmx.min.js')}}"></script>
    <script src="{{url_for('static', filename='js/vendor/htmx-ext-sse.js')}}"></script>
    <script src="{{url_for('static', filename='js/vendor/htmx-ext-response-targets.js')}}"></script>

    <script src="{{url_for('static', filename='js/vendor/marked.umd.js')}}"></script>
    <script src="{{url_for('static', filename='js/vendor/purify.min.js')}}"></script>


    <link rel="stylesheet" href="{{url_for('static', filename='css/main.css')}}">
    <link rel="stylesheet" href="{{url_for('static', filename='css/chat.css')}}">
  </head>
  <body
    hx-ext="response-targets"
    hx-target-5*="#errors"
    hx-target-4*="#errors">

    <div id="errors" hx-swap="beforeend"></div>
    <div class="app-container">
      <button id="sidebar-toggle" aria-label="Toggle sidebar">&#9776;</button>
      {% include "partials/sidebar.html" %}
      {% include "partials/chat.html" %}
    </div>

    <script>
      document.body.addEventListener('htmx:configRequest', (event) => {
        event.detail.headers['X-CSRFToken'] = '{{ csrf_token() }}';
      });

      document.body.addEventListener("htmx:configRequest", function (event) {
        const chat = document.getElementById("chat");
        const activeSessionId = chat?.dataset.sessionId;
        if (activeSessionId) {
          event.detail.headers["X-Active-Session"] = activeSessionId;
        }
      });


      function showServerError() {
        const errors = document.getElementById("errors");
        if (!errors) return;
        const box = document.createElement("div");
        box.className = "error-box";
        box.textContent = "⚠️ Unable to reach server.";
        const btn = document.createElement("button");
        btn.className = "close-error";
        btn.setAttribute("aria-label", "Close error");
        btn.textContent = "×";
        btn.onclick = () => box.remove();
        box.appendChild(btn);
        errors.appendChild(box);
      }

      document.body.addEventListener("htmx:sendError", showServerError);
      // document.body.addEventListener("htmx:responseError", showServerError);
    </script>
  </body>
</html>
